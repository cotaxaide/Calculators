<!DOCTYPE HTML>
<html>
<head>
	<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
	<meta name="author" content="Jeff Bogart, CO1/D18 Longmont TC">
	<title>Refund and Recovery Calculator</title>

<style type="text/css">
	html {
		background-color: #cccccc;
	}

	body {
		background-color: #cccccc;
		font-family: sans-serif;
		padding: 0 2.5% 0 2.5%;
	}

	button {
		cursor: pointer;
		background-color: lightgreen;
	}

	table {
		background-color: #eeeeee;
		border-collapse: collapse;
		width: 100%
	}

	h1 {
		text-align: center;
		font-size: 110%;
		text-decoration: underline;
	}

	h2 {
		font-weight: bold;
		background-color: lightgreen;
		text-align: center;
		font-size: 120%;
		padding: 0;
		margin: 0;
	}
	#NotDone {
		color: yellow;
		background-color: hotpink;
	}

	tr {
		vertical-align: top;
	}

	input {
		text-align: left;
		cursor: pointer;
	}
	input, select {
		background-color: white;
	}
	input[type="myinput"] {
		width: 7em;
		cursor: text;
		text-align: right;
	}
	input[type="myinput"]:disabled,
	select:disabled {
		width: 7em;
		background-color: lightgrey;
		font-weight: bold;
		cursor: not-allowed;
	}

	.center {
		text-align: center;
	}
	.underline {
		text-decoration: underline;
	}
	.hidden {
		display: none;
	}
	.title {
		font-size: 125%;
		font-weight: bold;
	}
	.instruction {
		font-style: italic;
	}
	.comment {
		font-style: italic;
	}
	.inputTitle {
		font-weight: bold;
	}
	.noPrint {
		width: 100%;
		float: left;
	}
	.question {
		border: 1px solid green;
		background-color: lightgreen;
		border-radius: 0.5em;
		cursor: help;
	}
	.new_block {
		background-color: #eeeeee;
		padding: 5px;
		border: 1px solid black;
		margin-top: 10px;
		width: 99%;
	}
	.data_entry {
		width: 100%;
	}
	.data_entry tr:nth-child(odd) {
		background-color: #e0e0e0;
	}
	.data_entry tr td {
		vertical-align: middle;
	}
	.data_entry tr td:first-child {
		min-width: 15em;
		width: 15em;
	}
	.data_entry tr td:nth-child(2) {
		width: 7em;
	}
	.test_results {
		text-align: right;
		padding-right: 5px;
		font-style: italic;
	}
	#Dependents {
		width: 6em;
		text-align: right;
	}
	#instructions {
		display: none;
	}
	#taxpayer_table {
		max-width: 60em;
	}
	#taxpayer_table td:first-child {
		width: 15em;
		border-right: 1px solid black;
	}
	#taxpayer_table td:nth-child(2) {
		width: 2em;
	}
	#taxpayer_table td:nth-child(3) {
		width; 9em;
	}
	#taxpayer_table td:nth-child(4) {
		width: 7em;
	}
	#instruction_label {
		cursor: help;
	}
	#NonRefundableDiv,
	#AllocationDiv,
	#ResultsDiv {
		page-break-before: auto;
		page-break-inside: avoid;
	}
	#CTCRow {
		border-bottom: 2px solid #eeeeee;
	}
	#ClearAndPrint {
		width: 16em; 
		text-align: center; 
		border: 0;
	       	background-color: transparent;
		z-index: 2;
		position: absolute;
		top: 0em;
		right: 0em;
	}
	#ClearAndPrint button {
		margin: 2px;
	}
	#TPName {
		text-align: left;
		width: auto;
		margin-top: 0;
		font-size: 120%;
		width: 21em;
	}
	#TPNameDiv {
		width: 99%;
	}
	@media print {
		.doPrint {
			display: inline;
		}
		.noPrint {
			display: none;
		}
		html {
			background-color: white;
			font-size: 0.8em;
		}
		body {
			font-size: 0.8em;
			background-color: white;
			padding: 0;
			margin: 0;
		}
		input,
		select,
		option {
			font-size: 0.8em;
		}
		table {
			width: 100%;
			background-color: white;
		}
		#InstructionDiv {
			display: none;
		}
	}
</style>

<script src="Tax_Data/IRS_2000.js"></script>
<script src="Tax_Data/IRS_2017.js"></script>
<script src="Tax_Data/IRS_2018.js"></script>
<script src="Tax_Data/IRS_2019.js"></script>
<script src="Tax_Data/IRS_2020.js"></script>
<script src="Tax_Data/IRS_2021.js"></script>
<script src="CommonRoutines.js"></script>
<script type="text/javascript">
	var VERSION;
	// --------------------------------------------------------------------------------
	// To Do:
	//	Provide for use of Schedule D
	// CHANGE HISTORY:
	VERSION = "(Version 2.15, 9/10/2021)";
	//	Changed nonitemizing charity to 300/600 for 2021
	//	Corrected test for filing status in nonitemizing charity
	//VERSION = "(Version 2.14, 9/9/2021)";
	//	Removed optional data and styling for 2017
	//	Added 2021 CTC for age under 6
	//	Added 2020 cash contributions when not itemizing
	//	Corrected nonrefundable tax credit calc (QBI was missing)
	//VERSION = "(Version 2.13c, 4/9/2020)";
	//	Added a warning message on results box if any data is needed
	//VERSION = "(Version 2.13b, 1/13/2020)";
	//	AGI variable error at CTCAGA
	//VERSION = "(Version 2.13a, 1/12/2020)";
	//	TaxSlayer change to where to enter Schedule 1 Line 1 bypass calculation
	//VERSION = "(Version 2.13, 1/4/2020)";
	//	Corrected nonrefundable calc - was assuming 10% bracket, not always true
	//	Added vertical line separating 2019 and 2018 information in TP box
	//VERSION = "(Version 2.12, 12/30/2019)";
	//	Added Non-refundable amount gained line
	//	4th estimated payment month comment changed from March to January
	//VERSION = "(Version 2.11a, 11/29/2019)";
	//	Dependents entry display changed to correct year(s)
	//VERSION = "(Version 2.11, 11/26/2019)";
	//	Reversed 2.10 SALT calculation change - it was OK after all
	//VERSION = "(Version 2.10, 11/25/2019)";
	//	Correction to SALT calculation when new SALT falls below SALT limit
	//	Changes to make sections display better when trying alternate figures
	//	Added dependent count for years prior to 2018 to calculate exemption amount
	//	Changed results display for nonrefundable credits used
	//VERSION = "(Version 2.09, 11/18/2019)";
	//	Corrected for MFS required to itemize not calculating correctly
	//VERSION = "(Version 2.08, 11/15/2019)";
	//	Reversed the default for the real estate tax refund
	//VERSION = "(Version 2.07, 11/6/2019)";
	//	Negative income set QBICurrent to blank, should be 0
	//	Changed QBI default to unchecked
	//VERSION = "(Version 2.06, 10/30/2019)";
	//	Fixed problem where Current QBI was not turning yellow
	//VERSION = "(Version 2.05, 8/31/2019)";
	//	Added QBI test section and revised negative taxable income tests
	//VERSION = "(Version 2.04a, 8/25/2019)";
	//	Changed Refundable to NonRefundable throughout
	//VERSION = "(Version 2.04, 8/24/2019)";
	//	Corrected QBI amount used in negative taxable income test
	//VERSION = "(Version 2.03a, 8/9/2019)";
	//	Corrected comment on SALT line to show MFS value
	//VERSION = "(Version 2.03, 7/2/2019)";
	//	Remove negative taxable income warning message if box is checked
	//	Added SALT limit amount in comment part of SALT total line
	//VERSION = "(Version 2.02, 6/12/2019)";
	//	Added fields for property and personal tax and calculate total state taxes
	//	Added a checkbox for state taxability of property tax refund/rebate
	//	Added a checkbox for states without sales taxes and alert message for 0 entry
	//	Corrected education credit line number
	//	Re-ordered non-refundable credits in correct exclusion order
	//VERSION = "(Version 2.01, 5/8/2019)";
	//	Display positive taxable income in negative taxable income test
	//	Added message to check the negative taxable income test box if positive
	//VERSION = "(Version 2.00, 5/7/2019)";
	//	Restructured as a linear set of entries, unhidden as needed
	//	Changes to accomodate the new limit on state tax deductions
	//	Added additional Schedule A possible refunds/rebates
	//	Added non-refundable entry table
	// --------------------------------------------------------------------------------

	//Contributors:
	//	Keith Gillen 		Wells Johnson 		Ronald Schmaeman
	//	Sam Kaplan 		Steve Conory 		Fred Petranka
	//	Bob Crews 		Kenny Hayes 		Leland Honda
	//	Anne Hoffman		Milus Campbell		Peter Steefel
	//	Deb Fisher		Lance Lauerhass		Dave Butner
	//	Paul Peyser		Maria Maggio		Frank Krider
	//	Vern Chartrand		Brad Kirby		Alvin Young

	//----------------------------------------------------------------------------------------
	//	GLOBAL VARIABLES
	//----------------------------------------------------------------------------------------
	var StateTaxRefundTaxable = 0;
	var SalesTaxRefundTaxable = 0;
	var PropertyTaxRefundTaxable = 0;
	var MedicalRefundTaxable = 0;
	var TotalTaxable = 0;
	var Exemptions = 0;
	var StateTaxRefundAlert = false;
	var SalesTaxRefundAlert = false;
	var PropertyTaxRefundAlert = false;
	var MedicalRefundAlert = false;
	var ComputationComplete = false;
	var ComputationCompleteAlert = false;
	var MyinputList = [];
	var NeedData = 0;
	var PY = 0;
	var CY = 0;
	var NY = 0;

	//----------------------------------------------------------------------------------------
	function Initialize() {
	// This function adds tax year options to the Filing Information section
	//----------------------------------------------------------------------------------------
		// Add tax year options
		TaxYear.length = 0;
		var tyOptIndex = 0;
		for (var ty = _StartYear; ty <= _StopYear; ty++) {
			var tyopti = document.createElement("option");
			tyopti.text = tyopti.value = ty;
			TaxYear.add(tyopti,tyOptIndex++);
		}
		TaxYear.value = _DefaultYear;
		FilingStatus.value = "MFJ";
		MFSItemize.style.display = "none";
		SNGDependent.style.display = "none";
		MustItemize.checked = false;
		Dependent.checked = false;
		StateWHBox.checked = false;
		SalesTaxBox.checked = false;
		NoSalesTaxBox.checked = false;
		MyinputList = document.getElementsByTagName("input");
		Recalculate();
	}

	//----------------------------------------------------------------------------------------
	function Do_Instructions() {	
	// This function shows or hides the instructions
	//----------------------------------------------------------------------------------------
		instructions.style.display = (instructions.style.display == "block") ? "none" : "block" ;
		instruction_label.innerHTML = "Click to " + ((instructions.style.display == "block") ? "hide instructions" : "show instructions") ;
	}

	//----------------------------------------------------------------------------------------
	function ChangeTaxBox(id) {
	// Called when the tax deduction source choice is updated
	//----------------------------------------------------------------------------------------
		// Toggle the other box(s)
		switch (id) {
			case "SalesTaxUsedBox":
				SalesTaxBox.checked = SalesTaxUsedBox.checked;
				StateWHBox.checked = (! SalesTaxUsedBox.checked);
			case "StateWHBox":
				SalesTaxUsedBox.checked = 
				SalesTaxBox.checked = (! StateWHBox.checked);
				break;
			case "SalesTaxBox":
				SalesTaxUsedBox.checked = SalesTaxBox.checked;
				StateWHBox.checked = (! SalesTaxBox.checked);
				break;
		}
	}

	//----------------------------------------------------------------------------------------
	function Recalculate() {	
	// This function readjusts settings when filing status information is changed
	//----------------------------------------------------------------------------------------

		// Initialize filing status to single, under 65, no dependents
		TPBlind.disabled = TP65.disabled = false;
		SPBlind.disabled = SP65.disabled = false;
		MFSItemize.style.display = "none";
		SNGDependent.style.display = "none";

		switch (FilingStatus.value) {
			case "MFJ":
				SPBlind.disabled = SP65.disabled = false;
				MustItemize.checked = false;
				Dependent.checked = false;
				Exemptions = 2;
				break;
			case "MFS":
				SPBlind.disabled = SP65.disabled = true;
				SPBlind.checked = SP65.checked = false;
				MFSItemize.style.display = "table-row";
				Dependent.checked = false;
				Exemptions = 1;
				break;
			case "SNG":
				SPBlind.disabled = SP65.disabled = true;
				SPBlind.checked = SP65.checked = false;
				SNGDependent.style.display = "table-row";
				MustItemize.checked = false;
				Exemptions = (Dependent.checked) ? 0 : 1;
				break;
			case "HOH":
			case "WID":
				SPBlind.disabled = SP65.disabled = true;
				SPBlind.checked = SP65.checked = false;
				MustItemize.checked = false;
				Dependent.checked = false;
				Exemptions = 1;
			}

		// Set year values, used a lot
		NY = +TaxYear.value;
		CY = NY - 1;
		PY = NY - 2;

		// Determine exemption amount
		Exemption.value = (Exemptions + +Dependents.value) * _Standard[CY].split(",")[0];

		// Show standard deduction amount if not a student. That will be determined later
		if (MustItemize.checked || UseSchedA.checked) {
			StandardDeduction.value =
			CYStandard.innerHTML = "N/A";
		}
		else if (! Dependent.checked) {
			StandardDeduction.value = _StandardDeduction(CY, FilingStatus.value,
				TP65.checked, TPBlind.checked, SP65.checked, SPBlind.checked,
				Dependent.checked, 0);
			CYStandard.innerHTML = StandardDeduction.value;
		}
		else CYStandard.innerHTML = "TBD";
	
		CTC0CountRow.style.display = (NY >= 2022) ?  "inline" : "none" ;
		CashContribRow.style.display = (NY >= 2021) ? "table-row" : "none" ;
		if (NY < 2021) CashContrib.value = "";
		if (NY >= 2019) {
			DependentsRow.style.display =
			DependentsNumber.style.display = "none";
			ODCCountRow.style.display = "inline";
			CTC0Count.value = 0;
			Dependents.value = "";
			TaxableStateLabel.innerHTML = "Schedule 1 line 1";
			TaxableSalesLabel.innerHTML = "Schedule 1 line 8";
		}
		else { // 2018
			DependentsRow.style.display =
			DependentsNumber.style.display = "inline"
			ODCCountRow.style.display = "none";
			CTC0Count.value = 0;
			TaxableStateLabel.innerHTML = "Schedule 1 line 10";
			TaxableSalesLabel.innerHTML = "Schedule 1 line 21";
		}

		PostCreditLineNo.innerHTML = "1040 line 13";
		SalesTaxText.style.display = "none";
		EnergyRow.style.display = "none";
		StateWHBox.style.display = "none";
		StateWHRow.style.display = "table-row";
		StateWHText.innerHTML = "to indicate sales tax used";
		SalesTaxUsedBox.style.display = "inline";
		PersonalRow.style.display = "table-row";
		PropertyRow.style.display = "table-row";
		SALTRow.style.display = "table-row";
		NonTaxableQBIDRow.style.display = "table-row";

		// Update lines containing dates

		TPNameHeader.innerHTML = CY + " Taxpayer Information";
		RefundHeader.innerHTML = "Refunds received in " + NY + " for the return filed in " + CY;
		SchedAHeader.innerHTML = CY + " Schedule A Test Information";
		NonTaxableHeader.innerHTML = "<hr />" + CY + " Negative Taxable Income Test Information";
		QBIHeader.innerHTML = "<hr />" + CY + " Qualified Business Income Adjustment Test Information";
		ExemptionText.innerHTML = "From Form 1040 line " + (_LineNo[CY + ":TaxAmount"] - 2);
		NonRefundableHeader.innerHTML = "<hr />" + CY + " Unused Non-Refundable Tax Credits Test Information";
		StandardHeader.innerHTML = "<hr />" + CY + " Standard Deduction Calculation for Dependent Taxpayer";
		AllocationHeader.innerHTML = "<hr />" + CY + " state tax payments";
		PYEstimatesQ.innerHTML = "State tax payments for " + PY + ", paid in " + CY;
		EstPY4QLabel.innerHTML = "&nbsp;&nbsp;" + PY + " 4Q estimated payment:";
		DuePY4QLabel.innerHTML = "&nbsp;&nbsp;" + PY + " state tax due payment:";
		CYEstimatesQ.innerHTML = "State tax payments for " + CY;
		PaidCYLabel.innerHTML = "&nbsp;&nbsp;" + CY + " withholding and Q1-3 estimated payments total:";
		PaidCYText.innerHTML = "(Calculated) Should include Q4 estimated payment if paid prior to 12/31/" + CY + " and a payment with an extension to file";
		EstPY4QText.innerHTML = "Typically paid in January. Also, include any other payments for " + CY + " or earlier";
		NYEstimatesQ.innerHTML = "State tax payment for " + CY + ", made in " + NY;
		EstNY4QLabel.innerHTML = "&nbsp;&nbsp;" + CY + " 4Q estimated payment:";
		Est4Q.innerHTML = "Check if there were ANY state income tax payments made in " + CY + " other than withholding";
		EstQ4Questions.style.display = (StateTaxRefund.value) ? "inline" : "none" ;
		CYAllocLabel.innerHTML = "&nbsp;&nbsp;" + CY;
		NYAllocLabel.innerHTML = "&nbsp;&nbsp;" + NY;
		NYAllocText.innerHTML = "This will reduce the " + CY + " Q4 deduction &ndash; part has already been refunded!";
		SALTLineNo.innerHTML = _LineNo[CY + ":SALT"];
		SALTLimit.innerHTML = _SALT[CY] / ((FilingStatus.value == "MFS") ? 2 : 1);
		ItemizedLineNo.innerHTML = _LineNo[CY + ":ItemDed"];
		UseSchedALineNo.innerHTML = _LineNo[CY + ":UseSchedA"];
		CashContribLineNo.innerHTML = _LineNo[CY + ":CashContrib"];
		CTCAGIText.innerHTML = 
		AGILineNo.innerHTML =
		QBIAGILineNo.innerHTML = "Form 1040 line " + _LineNo[CY + ":AGI"];
		SalaryText.innerHTML = "From Form 1040 line " + _LineNo[CY + ":Salary"];
		BusinessText.innerHTML = "From Form 1040 " + _LineNo[CY + ":Business"];
		OldNRCreditsLineNo.innerHTML = _LineNo[CY + ":NRCredit"];
		DedNY4QYear.innerHTML = CY;
		QBINetCGRow.style.display = "none"; // A place holder for calculated QBI Cap Gains
		QBIBusinessLineNo.innerHTML = "Form 1040 line " + _LineNo[CY + ":Business"];
		QBISEPLineNo.innerHTML = "Form 1040 line " + _LineNo[CY + ":SEP"];
		QBISEHILineNo.innerHTML = "Form 1040 line " + _LineNo[CY + ":SEHI"];
		QBICGLineNo.innerHTML = "Form 1040 line " + _LineNo[CY + ":CapGains"];
		QBIDividendLineNo.innerHTML = "Form 1040 lines " + _LineNo[CY + ":QualDiv"];
		if (QBISEP.value == "") QBISEP.value = 0; // Out of Scope so should be 0
		NonTaxableSkipLineNo.innerHTML = "Form 1040 line " + _LineNo[CY + ":Taxable"];
		PropertyLineNo.innerHTML = _LineNo[CY + ":Property"]; // Sched A
			// 2017 PropertyLineNo.innerHTML = "6";
		StateWHLabel.innerHTML = _LineNo[CY + ":StateWH"]; // Sched A

		StateTaxRefundAlert = false;
		SalesTaxRefundAlert = false;
		PropertyTaxRefundAlert = false;
		MedicalRefundAlert = false;
		ComputationCompleteAlert = false;
		ComputationComplete = false;

		// What results lines to display
		var ShowStatePT = (PropertyTaxRefundBox.checked) ? 0 : Math.round(+PropertyTaxRefund.value) ;
		var ShowSalesPT = (PropertyTaxRefundBox.checked) ? Math.round(+PropertyTaxRefund.value) : 0 ;
		var StateTest = +StateTaxRefund.value + ShowStatePT;
		var FedTest = +SalesTaxRefund.value + +MedicalRefund.value + ShowSalesPT;
		TaxableStateHeader.style.display =
		TaxableStateRow.style.display = (StateTest) ? "table-row" : "none" ;
		TaxableSalesHeader.style.display =
		TaxableSalesRow.style.display = (FedTest) ? "table-row" : "none" ;
		NotDone.style.display = (StateTest + FedTest) ? "block" : "none" ;
		DedNY4QRow.style.display =
		DedNY4QHeader.style.display = (DedNY4Q.value) ? "table-row" : "none" ;
	
		Tax_Calc();
	}

	//----------------------------------------------------------------------------------------
	function Tax_Calc() {
	// Calculates the taxable amounts
	// See Pub 525, worksheet 2 for detailed explanation
	//----------------------------------------------------------------------------------------
		
		// Clear the Taxable amounts figures
		TaxableState.value = TaxableSales.value = "";
		ComputationComplete = false;
		ResultsDiv.style.backgroundColor = "";

		// Verify that data is legitimate
		if (isNaN(StateTaxRefund.value) || (+StateTaxRefund.value < 0)) StateTaxRefund.value = "";
		StateTaxRefundTaxable = StateTaxRefund.value;
		if (isNaN(SalesTaxRefund.value) || (+SalesTaxRefund.value < 0)) SalesTaxRefund.value = "";
		SalesTaxRefundTaxable = SalesTaxRefund.value;
		if (isNaN(PropertyTaxRefund.value) || (+PropertyTaxRefund.value < 0)) PropertyTaxRefund.value = "";
		PropertyTaxRefundTaxable = PropertyTaxRefund.value;
		if (isNaN(MedicalRefund.value) || (+MedicalRefund.value < 0)) MedicalRefund.value = "";
		MedicalRefundTaxable = MedicalRefund.value;

		if (NoSalesTaxBox.checked) {
			SalesTaxBox.checked = false;
			SalesTaxUsedBox.checked = false;
			SalesTax.value = 0;
		}

		if (isNaN(Medical.value) || (+Medical.value < 0)) Medical.value = "";
		Medical.style.backgroundColor = "";
		if (isNaN(StateWH.value) || (+StateWH.value < 0)) StateWH.value = "";
		StateWH.style.backgroundColor = "";
		if (isNaN(SalesTax.value) || (+SalesTax.value < 0)) SalesTax.value = "";
		SalesTax.style.backgroundColor = "";
		if (isNaN(Property.value) || (+Property.value < 0)) Property.value = "";
		Property.style.backgroundColor = "";
		if (isNaN(Property.value) || (+Personal.value < 0)) Personal.value = "";
		Personal.style.backgroundColor = "";
		if (isNaN(CashContrib.value) || (+CashContrib.value < 0)) CashContrib.value = "";
		CashContrib.style.backgroundColor = "";
		if (isNaN(Itemized.value) || (+Itemized.value < 0)) Itemized.value = "";
		Itemized.style.backgroundColor = "";
		if (isNaN(Salary.value) || (+Salary.value < 0)) Salary.value = "";
		Salary.style.backgroundColor = "";
		if (isNaN(Business.value) || (+Business.value < 0)) Business.value = "";
		Business.style.backgroundColor = "";
		if (isNaN(QBIAGI.value) || (+QBIAGI.value < 0)) QBIAGI.value = "";
		QBIAGI.style.backgroundColor = "";
		if (isNaN(QBIBusiness.value) || (+QBIBusiness.value < 0)) QBIBusiness.value = "";
		QBIBusiness.style.backgroundColor = "";
		if (isNaN(QBISETax.value) || (+QBISETax.value < 0)) QBISETax.value = "";
		//QBISETax.style.backgroundColor = "";
		//if (isNaN(QBISEP.value) || (+QBISEP.value < 0)) QBISEP.value = "";
		QBISEP.style.backgroundColor = "";
		if (isNaN(QBISEHI.value) || (+QBISEHI.value < 0)) QBISEHI.value = "";
		QBISEHI.style.backgroundColor = "";
		if (isNaN(QBICG.value) || (+QBICG.value < 0)) QBICG.value = "";
		QBICG.style.backgroundColor = "";
		if (isNaN(QBIDividend.value) || (+QBIDividend.value < 0)) QBIDividend.value = "";
		QBIDividend.style.backgroundColor = "";
		if (isNaN(QBI199A.value) || (+QBI199A.value < 0)) QBI199A.value = "";
		QBI199A.style.backgroundColor = "";
		if (isNaN(QBIDMaximum.value) || (+QBIDMaximum.value < 0)) QBIDMaximum.value = "";
		//QBIDMaximum.style.backgroundColor = ""; // software controlled by options
		if (isNaN(QBINetCG.value) || (+QBINetCG.value < 0)) QBINetCG.value = "";
		//QBINetCG.style.backgroundColor = ""; // software controlled by options
		if (isNaN(QBIDCurrent.value) || (+QBIDCurrent.value < 0)) QBIDCurrent.value = "";
		//QBIDCurrent.style.backgroundColor = ""; // software controlled by options
		if (isNaN(AGI.value) || (+AGI.value < 0)) AGI.value = "";
		AGI.style.backgroundColor = "";
		if (isNaN(EstPY4Q.value) || (+EstPY4Q.value < 0)) EstPY4Q.value = "";
		EstPY4Q.style.backgroundColor = "";
		if (isNaN(DuePY4Q.value) || (+DuePY4Q.value < 0)) DuePY4Q.value = "";
		DuePY4Q.style.backgroundColor = "";
		if (isNaN(EstNY4Q.value) || (+EstNY4Q.value < 0)) EstNY4Q.value = "";
		EstNY4Q.style.backgroundColor = "";
		if (isNaN(OldCredits.value) || (+OldCredits.value < 0)) OldCredits.value = "";
		OldCredits.style.backgroundColor = "";
		if (isNaN(ForeignTax.value) || (+ForeignTax.value < 0)) ForeignTax.value = "";
		ForeignTax.style.backgroundColor = "";
		if (isNaN(ChildCare.value) || (+ChildCare.value < 0)) ChildCare.value = "";
		ChildCare.style.backgroundColor = "";
		if (isNaN(Education.value) || (+Education.value < 0)) Education.value = "";
		Education.style.backgroundColor = "";
		if (isNaN(Retirement.value) || (+Retirement.value < 0)) Retirement.value = "";
		Retirement.style.backgroundColor = "";
		if (isNaN(CTCAGI.value) || (+CTCAGI.value < 0)) CTCAGI.value = "";
		CTCAGI.style.backgroundColor = "";
		if (isNaN(CTCCount.value) || (+CTCCount.value < 0)) CTCCount.value = "";
		CTCCount.style.backgroundColor = "";
		if (isNaN(CTC0Count.value) || (+CTC0Count.value < 0)) CTC0Count.value = "";
		CTC0Count.style.backgroundColor = "";
		if (isNaN(ODCCount.value) || (+ODCCount.value < 0)) ODCCount.value = "";
		ODCCount.style.backgroundColor = "";
		if (isNaN(Energy.value) || (+Energy.value < 0)) Energy.value = "";
		Energy.style.backgroundColor = "";
		if (isNaN(Elderly.value) || (+Elderly.value < 0)) Elderly.value = "";
		Elderly.style.backgroundColor = "";

		// See if we have all we need to do a calculation
		NeedData = 0;
		TestingSchedAFor.innerHTML = "";
		TestingStandardFor.innerHTML = "";
		TestingNonTaxableFor.innerHTML = "";
		TestingQBIFor.innerHTML = "";
		TestingNonRefundableFor.innerHTML = "";
		TestingAllocationFor.innerHTML = "";

		// Miscellaneous calculations for aethetics
		var SStax = (SalesTaxUsedBox.checked) ? +SalesTax.value : +StateWH.value ;
		SALT.value = SStax + +Property.value + +Personal.value;

		// Are any credits entered
		if ((StateTaxRefund.value == "") && (SalesTaxRefund.value == "")
			&& (PropertyTaxRefund.value == "") && (MedicalRefund.value == "")) return;

	//----------------------------------------------------------------------------------------
		// Determine the taxable amount of the medical refund
		if (+MedicalRefund.value) {
			MedicalRow.style.display = "table-row";
			TestingSchedAFor.innerHTML = "Testing for medical refund taxability";
			SchedAButton.style.display = "inline";
			RefundsButton.style.display = "none";

			// Check the input data
			if (Medical.value == "") {
				NeedData++;
				Medical.style.backgroundColor = "yellow";
				Medical.focus();
			}
			if (NeedData) return;

			// OK to calculate
			TotalTaxable =
			MedicalRefundTaxable = Math.min(+Medical.value, +MedicalRefund.value);
		}
		else {
			MedicalRow.style.display = "none";
			Medical.value = "";
		}
		TestingSchedAFor.innerHTML = "";
			SchedAButton.style.display = "none";

		if (Status_Test("SchedAResult")) return;

	//----------------------------------------------------------------------------------------
		// Determine amount of state tax or sales tax refund is taxable

		if ((+StateTaxRefund.value + +SalesTaxRefund.value) || (TaxYear.value > 2018)) {
			TestingSchedAFor.innerHTML = "Testing for sales tax and state income tax withholding difference";
			RefundsButton.style.display = "none";
			SchedAButton.style.display = "inline";
			StateWHRow.style.display = "table-row";

			if (+StateTaxRefund.value && SalesTaxUsedBox.checked) StateTaxRefundTaxable = 0;
			if (+SalesTaxRefund.value && (! SalesTaxUsedBox.checked)) SalesTaxRefundTaxable = 0;
			if (Status_Test("SchedAResult")) return;

			if (+StateTaxRefundTaxable + +SalesTaxRefundTaxable) {
				TestingSchedAFor.innerHTML = "Testing for sales tax and state income tax withholding difference";
				// Check the input data
				if (StateWH.value == "") {
					NeedData++;
					StateWH.style.backgroundColor = "yellow";
					StateWH.focus();
				}
				else if (SalesTax.value == 0) {
					if (NoSalesTaxBox.checked) {
						SalesTax.value = 0;
						}
					else {
						if (SalesTax.value === "0") {
							alert("Entering the sales tax amount is required.");
						}
						NeedData++;
						SalesTax.style.backgroundColor = "yellow";
						SalesTax.focus();
					}
				}
				if (NeedData) return;

				// OK to calculate

				// Find the effect of the refund
				StateTaxRefundTaxable = Math.min(StateTaxRefundTaxable, StateWH.value);
				SalesTaxRefundTaxable = Math.min(SalesTaxRefundTaxable, SalesTax.value);

				if (! (+StateTaxRefundTaxable + +SalesTaxRefundTaxable)) {
					StateWH.style.backgroundColor = "";
					SalesTax.style.backgroundColor = "";
				}

				if (SalesTaxUsedBox.checked) {
					SalesTaxRefundTaxable = Math.max(0, Math.min(SalesTaxRefundTaxable,
						+SalesTax.value - +StateWH.value));
					StateTaxRefundTaxable = 0;
				}
				else {
					StateTaxRefundTaxable = Math.max(0, Math.min(StateTaxRefundTaxable,
						+StateWH.value - +SalesTax.value));
					SalesTaxRefundTaxable = 0;
				}

				TotalTaxable += StateTaxRefundTaxable + SalesTaxRefundTaxable;
			}
		}
		else {
			StateWHRow.style.display = "none";
			SalesTax.value = "";
			StateWH.value = "";
		}
		TestingSchedAFor.innerHTML = "";
		SchedAButton.style.display = "none";

		if (Status_Test("SchedAResult")) return;

	//----------------------------------------------------------------------------------------
		// Determine if property tax refund is limited
		if ((PropertyTaxRefund.value) || (TaxYear.value > 2018)) {
			PropertyRow.style.display = "table-row";

			// Check the input data
			if (PropertyTaxRefund.value) {
				TestingSchedAFor.innerHTML = "Testing for real estate tax refund taxability";
			}
			else {
				TestingSchedAFor.innerHTML = "Testing for state and local tax (&quot;SALT&quot;) limitation";
			}

			if (Property.value == "") {
				NeedData++;
				Property.style.backgroundColor = "yellow";
				Property.focus();
			}
			if (NeedData) return;

			// OK to calculate
			PropertyTaxRefundTaxable = Math.min(PropertyTaxRefundTaxable, +Property.value);
		}
		else {
			PropertyRow.style.display = "none" ;
			Property.value = "";
		}
		TestingSchedAFor.innerHTML = "";
		SchedAButton.style.display = "none";

		if (Status_Test("SchedAResult")) return;

	//----------------------------------------------------------------------------------------
		// Determine if deduction for taxes paid is limited
		var SALTRefund = +SalesTaxRefundTaxable + +StateTaxRefundTaxable + +PropertyTaxRefundTaxable;
		var SALTdiff = 0;
		if (_SALT[CY] && SALTRefund) {
			TestingSchedAFor.innerHTML = "Testing for state and local tax (&quot;SALT&quot;) limitation";
			RefundsButton.style.display = "none";
			SchedAButton.style.display = "inline";
			SALTRow.style.display = "table-row";

			if (Personal.value == "") {
				NeedData++;
				Personal.style.backgroundColor = "yellow";
				Personal.focus();
			}
			if (NeedData) return;

			// OK to calculate
			NewSALT = SALT.value - SALTRefund;
			SALTlimit = _SALT[CY] / ((FilingStatus.value == "MFS") ? 2 : 1);
			SALTdiff = Math.max(0, SALTlimit - NewSALT);

			// Determine amount attributable to each tax refund
			StateWHPct = StateTaxRefundTaxable / SALTRefund;
			SalesTaxPct = SalesTaxRefundTaxable / SALTRefund;
			PropertyPct = PropertyTaxRefundTaxable / SALTRefund;
			SalesTaxRefundTaxable = Math.min(SalesTaxRefundTaxable, (SALTdiff * SalesTaxPct));
			StateTaxRefundTaxable = Math.min(StateTaxRefundTaxable, (SALTdiff * StateWHPct));
			PropertyTaxRefundTaxable = Math.min(PropertyTaxRefundTaxable, (SALTdiff * PropertyPct));

		}
		else {
			SALTRow.style.display = "none";
			}
		TestingSchedAFor.innerHTML = "";
		SchedAButton.style.display = "none";
		RevisedItemizedRow.style.display = ItemizedRow.style.display = "none";

		if (Status_Test("SchedAResult")) return;

	//----------------------------------------------------------------------------------------
		// Determine the standard deduction if taxpayer is a dependent
		var EarnedIncome = 0;
		if (Dependent.checked) {
			TestingStandardFor.innerHTML = "Determining standard deduction for a dependent";
			StandardDiv.style.display = "block";
			StandardButton.style.display = "inline";

			// Check the input data
			if (Salary.value == "") {
				NeedData++;
				Salary.style.backgroundColor = "yellow";
				Salary.focus();
			}
			Itemized.style.display = "table-row";
			if (Business.value == "") {
				NeedData++;
				Business.style.backgroundColor = "yellow";
				Business.focus();
			}

			// OK to calculate
			EarnedIncome = +Salary.value + +Business.value;
		}
		else {
			StandardDiv.style.display = "none";
			Salary.value = "";
			Business.value = "";
		}

		// Determine the standard deduction
		if (MustItemize.checked || UseSchedA.checked) {
			StandardDeduction.value =
			CYStandard.innerHTML = "N/A";
		}
		else {
			StandardDeduction.value = _StandardDeduction(CY, FilingStatus.value,
				TP65.checked, TPBlind.checked, SP65.checked, SPBlind.checked,
				Dependent.checked, EarnedIncome);
			CYStandard.innerHTML = StandardDeduction.value;
		}
		TestingStandardFor.innerHTML = "";
		StandardButton.style.display = "none";

		if (NeedData) return;

	//----------------------------------------------------------------------------------------
		// Compare itemized and standard deduction
		if (TotalTaxable) {
			// Determine the new Schedule A total to be used for testing
			TestingSchedAFor.innerHTML = "Comparing itemized and standard deductions";
			RefundsButton.style.display = "none";
			SchedAButton.style.display = "inline";
			RevisedItemizedRow.style.display = ItemizedRow.style.display = "table-row";
			RevisedItemized.value = "";

			if (MustItemize.checked || UseSchedA.checked) {
				StandardDeduction.value = Itemized.value;
			}
			else {
				// Check the input data
				if ((CY >= 2020) && CashContrib.value == "") {
					NeedData++;
					CashContrib.style.backgroundColor = "yellow";
					CashContrib.focus();
				}
				if (NeedData) return;
	
				if (Itemized.value == "") {
					NeedData++;
					Itemized.style.backgroundColor = "yellow";
					Itemized.focus();
				}
				if (NeedData) return;

				if (Itemized.value < (+SALT.value + +Medical.value + +CashContrib.value)) {
					NeedData++;
					Itemized.style.backgroundColor = "hotpink";
					alert("Itemized deduction total seems too low.");
				}
				if (NeedData) return;
		
				// OK to calculate
				NonSchedAContrib = Math.min((150 * ((FilingStatus.value == "MFS") ? 1 : 2 )), +CashContrib.value);
				if (CY >= 2021) NonSchedAContrib *= 2;
				ItemizedDiff = Math.max(0, +Itemized.value - +StandardDeduction.value - NonSchedAContrib);
				NewTotalTaxable = Math.min(ItemizedDiff, TotalTaxable);
				NewTotalPct = NewTotalTaxable / TotalTaxable;

				// Determine amount attributable to each tax refund
				SalesTaxRefundTaxable = SalesTaxRefundTaxable * NewTotalPct;
				StateTaxRefundTaxable = StateTaxRefundTaxable * NewTotalPct;
				PropertyTaxRefundTaxable = PropertyTaxRefundTaxable * NewTotalPct;
				MedicalRefundTaxable = MedicalRefundTaxable * NewTotalPct;
			}
		}
		else {
			RevisedItemizedRow.style.display = ItemizedRow.style.display = "none";
			Itemized.value = "";
		}

		TestingSchedAFor.innerHTML = "";
		SchedAButton.style.display = "none";
		
		// Determine a revised deduction amount for future calculations
		if (MustItemize.checked || UseSchedA.checked) {
			RevisedItemized.value = 
			RevisedDeduction = Itemized.value;
		}
		else {
			RevisedItemized.value = 
			RevisedDeduction = Math.max((+Itemized.value - TotalTaxable), (+StandardDeduction.value + NonSchedAContrib));
		}
		
		if (Status_Test("SchedAResult")) return;


	//----------------------------------------------------------------------------------------
		// Test for QBI adjustment
		QBIRate = 0;
		if ((TotalTaxable) && (CY >= 2018)) {

			QBIDiv.style.display = "block";
			QBIRate = +_QBILimits[TaxYear.value + ":Rate"];
			if (! QBITestSkip.checked) {
				TestingQBIFor.innerHTML = "Testing for QBI adjustment";
				QBITable1.style.display =
				QBITable3.style.display = "inline-table";
				QBIDMaximum.disabled = false;
				QBIDMaximumLineNo.innerHTML = "From QBI worksheet (Form 8995) line 10";
				QBINetCG.disabled = false;
				QBINetCGLineNo.innerHTML = "From QBI worksheet (Form 8995) line 12";
				QBIDCurrent.disabled = false;
				QBIDCurrentLineNo.innerHTML = "From QBI worksheet (Form 8995) line 15 or Form 1040 line ";
				QBIDCurrentLineNo.innerHTML += _LineNo[CY + ":QBI"];
				QBIDAdditional.value = "";
				//NonTaxableOption.style.display = "none";

				// Check the input data
				if (QBIAGI.value == "") {
					QBITable2.style.display = "none";
					NeedData++;
					QBIAGI.style.backgroundColor = "yellow";
					QBIAGI.focus();
				}

				if (NeedData) return

				// Current taxable income must be positive for a QBI deduction
				var TaxableIncome = +QBIAGI.value - +Itemized.value;
				if (TaxableIncome <= 0) {
					QBIDCurrent.value = 0; // v 2.07
					QBIDCurrentLineNo.innerHTML = "(Calculated)";
					QBIDCurrent.disabled = true;
					QBIDAdditional.value = 0;
				}

				var PreQBITaxableIncome = +QBIAGI.value - RevisedDeduction;
				var PreQBICurrent = Math.max(0, (QBIAGI.value - +Itemized.value));

				if (QBINoWorksheet.checked) {
					QBITable2.style.display = "inline-table";
					QBIDMaximum.disabled = true;
					QBIDMaximum.value = "";
					QBIDMaximumLineNo.innerHTML = "(Calculated)";
					QBIDMaximum.style.backgroundColor = "";
					QBINetCG.disabled = true;
					QBINetCG.value = "";
					QBINetCGLineNo.innerHTML = "(Calculated)";
					QBINetCG.style.backgroundColor = "";
					QBIDCurrent.disabled = true;
					QBIDCurrent.value = "";
					QBIDCurrentLineNo.innerHTML = "(Calculated)";
					QBIDCurrent.style.backgroundColor = "";

					if (Dependent.checked) QBIBusiness.value = Math.round(+Business.value);
					if (+QBIBusiness.value > 0) QBISETax.value = _SETax(PY, QBIBusiness.value)[1];
					if (QBIBusiness.value == "") {
						NeedData++;
						QBISETax.value = "";
						QBIBusiness.style.backgroundColor = "yellow";
						QBIBusiness.focus();
					}
					else if (QBISETax.value == "") {
						NeedData++;
						QBISETax.style.backgroundColor = "yellow";
						QBISETax.focus();
					}
					else if (QBISEP.value == "") {
						NeedData++;
						QBISEP.style.backgroundColor = "yellow";
						QBISEP.focus();
					}
					else if (QBISEHI.value == "") {
						NeedData++;
						QBISEHI.style.backgroundColor = "yellow";
						QBISEHI.focus();
					}
					else if (QBICG.value == "") {
						NeedData++;
						QBICG.style.backgroundColor = "yellow";
						QBICG.focus();
					}
					else if (QBIDividend.value == "") {
						NeedData++;
						QBIDividend.style.backgroundColor = "yellow";
						QBIDividend.focus();
					}
					else if (QBI199A.value == "") {
						NeedData++;
						QBI199A.style.backgroundColor = "yellow";
						QBI199A.focus();
					}

					if (NeedData) return;

					QBISEIncome = (+QBIBusiness.value - +QBISETax.value - +QBISEP.value - +QBISEHI.value)
					QBINetCG.value = +QBICG.value + +QBIDividend.value;
					QBILimit = _QBILimits[CY + ":" + FilingStatus.value];
					QBIDMaximum.value = _QBICalc(CY, FilingStatus.value, QBISEIncome, QBINetCG.value, QBI199A.value, QBILimit);
					QBIDCurrent.value = _QBICalc(CY, FilingStatus.value, QBISEIncome, QBINetCG.value, QBI199A.value, PreQBICurrent);
				}
				else {
					QBITable2.style.display = "none";
					QBIDMaximum.style.backgroundColor = "";
					QBINetCG.style.backgroundColor = "";
					QBIDCurrent.style.backgroundColor = "";
					if (QBIDMaximum.value == "") {
						NeedData++;
						QBIDMaximum.style.backgroundColor = "yellow";
						QBIDMaximum.focus();
					}
					//else if (QBINetCG.value == "") {
					//	NeedData++;
					//	QBINetCG.style.backgroundColor = "yellow";
					//	QBINetCG.focus();
					//}
					else if (QBIDCurrent.value == "") {
						NeedData++;
						QBIDCurrent.style.backgroundColor = "yellow";
						QBIDCurrent.focus();
					}

					if (NeedData) return
						
					// Figure Net CG value
					QBIUsed = +QBIDCurrent.value / QBIRate;
					QBINetCG.value = Math.max(0, (PreQBICurrent - QBIUsed));
				}

				if (NeedData) return;

				// OK to calculate

				if (TaxableIncome >= 0) {
					// Amount of current negative taxable income to disregard, if any
					// CurrentNegative = Math.max(0, -TaxableIncome);
					// Amount to attribute to now positive taxable income
					// PreQBIPositive = Math.max(0, (TotalTaxable - CurrentNegative));
					// Amount changed due to now positive taxable income
					// PreQBIRevised = PreQBICurrent + PreQBIPositive - +QBINetCG.value;
					PreQBIRevised = PreQBICurrent + TotalTaxable - +QBINetCG.value;
					QBIIncomeLimit = PreQBIRevised * QBIRate;
					QBIDRevised = Math.min(QBIDMaximum.value, QBIIncomeLimit);
					QBIDAdditional.value = Math.round(Math.max(0, (QBIDRevised - +QBIDCurrent.value)));
					QBIDAdditionalText.innerHTML = "(Calculated additional amount the refund would have allowed)";
				
					NewTotalTaxable = TotalTaxable - +QBIDAdditional.value;
					NewTotalPct = NewTotalTaxable / TotalTaxable;

					// Determine amount attributable to each tax refund
					SalesTaxRefundTaxable = SalesTaxRefundTaxable * NewTotalPct;
					StateTaxRefundTaxable = StateTaxRefundTaxable * NewTotalPct;
					PropertyTaxRefundTaxable = PropertyTaxRefundTaxable * NewTotalPct;
					MedicalRefundTaxable = MedicalRefundTaxable * NewTotalPct;
				}
				else {
					QBIDAdditionalText.innerHTML = "(Taxable income was negative - see next section)";
				}
				NonTaxableQBIDRow.style.display = "table-row";
			}
			else { // No adjustment needed;
				QBITable1.style.display =
				QBITable2.style.display =
				QBITable3.style.display = "none";
				QBINoWorksheet.checked = false;
				QBIAGI.value = "";
				QBIBusiness.value = "";
				QBI199A.value = "";
				QBIDCurrent.value = "";
				NonTaxableButton.style.display = "none";
				NonTaxableQBIDRow.style.display = "none";
			}

			TestingQBIFor.innerHTML = "";
			ExemptionRow.style.display = "none";
			Exemption.value = 0;

			if (Status_Test("QBIResult")) return;

			// Set up for the negative taxable income test
			NonTaxableSkip.checked = (TaxableIncome >= 0) ? true : false;
			NonTaxableOption.style.display = (NonTaxableSkip.checked) ? "inline" : "none";
			NonTaxableDiv.style.display = (NonTaxableSkip.checked) ? "none" : "block";
			NonTaxableTable.style.display = (NonTaxableSkip.checked) ? "none" : "block";
		}

		if (CY < 2018) {
			QBIDiv.style.display = "none";
			ExemptionRow.style.display = "table-row";
			NonTaxableOption.style.display = "inline";
		}

	//----------------------------------------------------------------------------------------
		// Test for negative taxable income
		if (TotalTaxable) {

			if (QBIAGI.value == "") {
				NonTaxableDiv.style.display = "block";
				AGI.disabled = false;
			}

			if (! NonTaxableSkip.checked) {
				TestingNonTaxableFor.innerHTML = "Testing for negative taxable income";
				NonTaxableButton.style.display = "inline";
				TaxablePositive.style.display = "none";
				NonTaxableTable.style.display = "inline-table";
				NonRefundableDiv.style.display = "none";
				RevisedTaxable = "";

				if (! QBITestSkip.checked) {

					// Check the input data
					if (QBIAGI.value) {
						AGI.value = QBIAGI.value;
						AGI.disabled = true;
					}

					// Figure QBID amount that would have been available
					CurrentNegative = Math.max(0, (+Itemized.value - +QBIAGI.value));
					PositiveIncrease = Math.max(0, (TotalTaxable - CurrentNegative));
					QBIDLimit = Math.round(PositiveIncrease * QBIRate);
					QBIDAvailable = QBIDMaximum.value - QBIDCurrent.value;
					NonTaxableQBID.value = Math.min(QBIDAvailable, QBIDLimit);
				} 

				if (AGI.value == "") {
					NeedData++;
					AGI.style.backgroundColor = "yellow";
					AGI.focus();
				}
				
				if (NeedData) return;

				// OK to calculate

				TestDifference = Math.max(0, +AGI.value - RevisedDeduction + +Exemption.value);
				// Test for inconsistant manual entry amounts
				if (+Exemption.value > TestDifference) {
					Message = "Check your entries.";
					Message += " The taxable amount will be positive if this AGI is used!";
					Message += "\n\nIf your entries are correct,";
					Message += " check the box on this section to skip this test.";
					alert(Message);
					AGI.style.backgroundColor = "hotpink";
					TaxablePositive.style.display = "inline";
					NonTaxableDiv.style.display = "block"; // may be leftover data causing this
					return;
				}


				// Negative amount that can be recovered
				CurrentNegative = Math.max(0, (+Itemized.value + +Exemption.value - +AGI.value));
				NonTaxableRecovered.value = Math.min(CurrentNegative, TotalTaxable);

				NewTotalTaxable = Math.max(0, (TotalTaxable - NonTaxableRecovered.value - NonTaxableQBID.value));
				NewTotalPct = NewTotalTaxable / TotalTaxable;

				// Determine amount attributable to each tax refund
				SalesTaxRefundTaxable = SalesTaxRefundTaxable * NewTotalPct;
				StateTaxRefundTaxable = StateTaxRefundTaxable * NewTotalPct;
				PropertyTaxRefundTaxable = PropertyTaxRefundTaxable * NewTotalPct;
				MedicalRefundTaxable = MedicalRefundTaxable * NewTotalPct;
			}
			else { // Taxable is positive
				NonTaxableTable.style.display = "none";
				TaxablePositive.style.display = "none";
				AGI.value = "";
				RevisedTaxable = "";
			}
		}
		else {
			AGI.value = "";
			RevisedTaxable = "";
		}
		TestingNonTaxableFor.innerHTML = "";
		NonTaxableButton.style.display = "none";

		if (Status_Test("NonTaxableResult")) return;

	//----------------------------------------------------------------------------------------
		// Test for non-refundable credits
		if (TotalTaxable) {
			NonRefundableTable.style.display = "none";
			NonRefundableAmendedTable.style.display = "none";
			NonRefundableDiv.style.display = "block";
			TestingNonRefundableFor.innerHTML = "Testing for reduction due to unused non-refundable credits";
			NonRefundableButton.style.display = "inline";
			NewCredits.value = "";
			TaxBracketGain.value = "";

			NeedData++;
			if (! NoNonRefundables.checked) {
				NeedData = 0;

				NonRefundableTable.style.display = "inline-table";

				if (OldCredits.value == "") {
					NeedData++;
					OldCredits.style.backgroundColor = "yellow";
					OldCredits.focus();
				}
				if (NeedData) return;

				NonRefundableAmendedTable.style.display = "inline-table";
				TestingNonRefundableFor.innerHTML = "Testing for reduction due to unused non-refundable credits";
				NonRefundableButton.style.display = "inline";

				// Copy AGI value from earlier entries
				if (AGI.value != "") CTCAGI.value = AGI.value;
				else if (QBIAGI.value != "") CTCAGI.value = QBIAGI.value;

				// Calculate the CTC if the data is available
				CTCCalc = (CTCAGI.value != "")
					&& (CTCCount.value != "")
					&& (CTC0Count.value != "")
					&& (ODCCount.value != "");
				if (CTCCalc) {
					CTCChild = +CTCCount.value + (+CTC0Count.value / 100);
					CTCReturn = _CTCLookup(CY, FilingStatus.value,
							CTCChild, (+CTCCount.value + +ODCCount.value),
							0, CTCAGI.value, 0);
					CTC.value = +CTCReturn[0] + +CTCReturn[1];
				}
				else CTC.value = "";

				if (CTC.value == "") {
					CTCTable.style.display = "inline";
					if (CTCAGI.value == "") {
						CTC.value = "";
						NeedData++;
						CTCAGI.style.backgroundColor = "yellow";
						CTCAGI.focus();
					}
					if (NeedData) return;
					else if (CTCCount.value == "") {
						CTC.value = "";
						NeedData++;
						CTCCount.style.backgroundColor = "yellow";
						CTCCount.focus();
					}
					if (NeedData) return;
					else if (CTC0Count.value == "") {
						CTC.value = "";
						NeedData++;
						CTC0Count.style.backgroundColor = "yellow";
						CTC0Count.focus();
					}
					if (+CTC0Count.value > +CTCCount.value) {
						alert("The number of children under 6 cannot be larger than the number of children under 17");
						CTC0Count.style.backgroundColor = "hotpink";
						return;
					}
					if (NeedData) return;
					else if (ODCCount.value == "") {
						CTC.value = "";
						NeedData++;
						ODCCount.style.backgroundColor = "yellow";
						ODCCount.focus();
					}
					if (NeedData) return;
				}
				else if (ForeignTax.value == "") {
					ForeignTax.style.backgroundColor = "yellow";
					NeedData++;
					ForeignTax.focus();
					}
				else if (ChildCare.value == "") {
					ChildCare.style.backgroundColor = "yellow";
					NeedData++;
					ChildCare.focus();
					}
				else if (Elderly.value == "") {
					Elderly.style.backgroundColor = "yellow";
					NeedData++;
					Elderly.focus();
					}
				else if (Education.value == "") {
					Education.style.backgroundColor = "yellow";
					NeedData++;
					Education.focus();
					}
				else if (Retirement.value == "") {
					Retirement.style.backgroundColor = "yellow";
					NeedData++;
					Retirement.focus();
					}
				else if ((NY <= 2018) && (Energy.value == "")) {
					Energy.style.backgroundColor = "yellow";
					NeedData++;
					Energy.focus();
					}

				// Is at least the old data entered
				NewCredits.value = +ForeignTax.value + +ChildCare.value + +Education.value
					+ +Retirement.value + +Energy.value + +Elderly.value + +CTC.value;
				if ((NeedData == 0) && (+NewCredits.value < +OldCredits.value)) {
					Message = "The maximum values do not, but should, total";
					Message += " to at least the current total credits.";
					Message += "\n\nPlease check the amounts you have entered.";
					alert(Message);
					return;
				}

				// OK to calculate

				// OldCredits bring the tax to 0, so NewCredits will determine the deduction
				// Figure the tax bracket and taxable amount increase allowed
				var NewQBID = +QBIDCurrent.value + +QBIDAdditional.value;
				var NewTaxable = Math.max(0, +CTCAGI.value - RevisedDeduction - NewQBID + +Exemption.value);
				NewTax = _TaxLookup((+TaxYear.value - 1), FilingStatus.value, NewTaxable, 0, true);
				NewCredits.value = Math.min(NewTax, +NewCredits.value);
				var additionalForCredits = +Brackets(OldCredits.value, NewCredits.value);
				NRCGain.value = Math.max(0, +NewCredits.value - +OldCredits.value);
				TaxBracketGain.value = Math.min(additionalForCredits, TotalTaxable);

				NewTotalTaxable = Math.max(0, +TotalTaxable - +additionalForCredits);
				NewTotalPct = +NewTotalTaxable / +TotalTaxable;

				// Determine amount attributable to each tax refund
				SalesTaxRefundTaxable = +SalesTaxRefundTaxable * +NewTotalPct;
				StateTaxRefundTaxable = +StateTaxRefundTaxable * +NewTotalPct;
				PropertyTaxRefundTaxable = +PropertyTaxRefundTaxable * +NewTotalPct;
				MedicalRefundTaxable = +MedicalRefundTaxable * +NewTotalPct;

				if (Status_Test("NonRefundableResult")) {
					AllocationDiv.style.display = "none"; // close if previously open
					return;
				}
				if (NeedData) return;
			}
			else {
				OldCredits.value = "";
				ForeignTax.value = "";
				ChildCare.value = "";
				Education.value = "";
				Retirement.value = "";
				CTCAGI.value = "";
				CTCCount.value = "";
				CTC0Count.value = "";
				ODCCount.value = "";
				CTC.value = "";
				Energy.value = "";
				Elderly.value = "";
				NewCredits.value = "";
				NeedData = 0;
				TestingNonRefundableFor.innerHTML = "";
				NonRefundableButton.style.display = "none";
			}
		}

		if (NeedData == 0) {
			TestingNonRefundableFor.innerHTML = "";
			NonRefundableButton.style.display = "none";
		}

		if (Status_Test("NonRefundableResult")) {
			AllocationDiv.style.display = "none"; // close if previously open
			return;
		}

	//----------------------------------------------------------------------------------------
		// Allocate state tax refund if it bridges multiple years
		CYAlloc.value = Math.round(StateTaxRefundTaxable);
		NYAlloc.value = 0;
		DedNY4Q.value = "";
		if (StateTaxRefundTaxable && Est4QYes.checked) {
			AllocationDiv.style.display = "block";
			AllocationTable.style.display = (NoAllocation.checked) ? "none" : "table" ;

			if (! NoAllocation.checked) {
				TestingAllocationFor.innerHTML = "Allocating refund based on year paid";
				AllocationButton.style.display = "inline";
				AllocationTable.style.display = "table";
				PaidCY.value = +StateWH.value - +EstPY4Q.value - +DuePY4Q.value;

				// Check inputs
				if (EstPY4Q.value == "") {
					NeedData++;
					EstPY4Q.style.backgroundColor = "yellow";
				}
				if (DuePY4Q.value == "") {
					NeedData++;
					DuePY4Q.style.backgroundColor = "yellow";
				}
				if (NeedData) return;

				if (PaidCY.value < 0) {
					EstPY4Q.style.backgroundColor = "hotpink";
					DuePY4Q.style.backgroundColor = "hotpink";
					Message = "Please check the pink entries.";
					Message += "\n\nThe amount paid in " + CY;
					Message += " should not be negative!";
					Message += "\n\nWas it included as a deduction?"; 
					alert(Message);
					return;
				}

				if (EstNY4Q.value == "") {
					NeedData++;
					EstNY4Q.style.backgroundColor = "yellow";
				}
				if (NeedData) return;

				// OK to calculate
				PYTotal = (+PaidCY.value + +EstNY4Q.value);
				if (PYTotal == 0) CYAlloc.value = 0;
				else CYAlloc.value = Math.round((+StateTaxRefundTaxable * +PaidCY.value) / PYTotal);
				NYAlloc.value = Math.round(+StateTaxRefundTaxable - +CYAlloc.value);
				StateTaxRefundTaxable = +CYAlloc.value; // update to the new taxable amount
				DedNY4Q.value = Math.round(Math.max(0, +EstNY4Q.value - +NYAlloc.value));
			}
		}
		else {
			AllocationDiv.style.display = "none";
		}

		DedNY4QRow.style.display =
		DedNY4QHeader.style.display = (DedNY4Q.value) ? "table-row" : "none" ;
		if (NeedData == 0) ComputationComplete = true;

		Status_Test();

		TestingAllocationFor.innerHTML = "";
		AllocationButton.style.display = "none";
	}

	//----------------------------------------------------------------------------------------
	function Brackets(tax0, tax1) {
	// Calculates the bracket(s) for the credits 
	//----------------------------------------------------------------------------------------
		var rateList = _TaxRates[CY + ":PCT"].split(",");
		var sizeList = _TaxRates[CY + ":" + FilingStatus.value].split(","); // maximum for the rate

		// Compare the starting tax with the tax resulting from each tax bracket taxable income
		var taxBracket = 0;
		while ( (taxBracket < rateList.length)
			&& (+tax0 > (bracketMaxTax = +sizeList[taxBracket] * +rateList[taxBracket]))
		      ) { taxBracket++; }

		// credits may span tax brackets...

		// How much in the tax0 bracket?
		var tax1a = Math.max(0, (Math.min(+tax1, bracketMaxTax) - +tax0));
		var cE1a = Math.round(tax1a / rateList[taxBracket]);

		// How much in the next bracket (unlikely to jump 2 brackets)
		var tax1b = Math.max(0, +tax1 - +tax0 - tax1a);
		var cE1b = Math.round(tax1b / rateList[taxBracket+1]);

		creditExclusion = cE1a + cE1b;
		var tbmsg = "At " + (100 * rateList[taxBracket]) + "% tax rate, exclusion = " + Math.min(cE1a, TotalTaxable);
		if (cE1b > 0) tbmsg += "<br />At " + (100 * rateList[taxBracket+1]) + "% tax rate, exclusion = " + cE1b;
		TaxBracket.innerHTML = tbmsg;
		return creditExclusion;
	}

	//----------------------------------------------------------------------------------------
	function Status_Test(result_line) {
	// result_line is the name of the element in which to display the result
	// Alert message if a conclusion is reached
	//----------------------------------------------------------------------------------------
		var Message = "";
		TestingSchedAFor.innerHTML = "";
		TestingStandardFor.innerHTML = "";
		TestingNonTaxableFor.innerHTML = "";
		TotalRefund = +StateTaxRefund.value + +SalesTaxRefund.value
			+ +PropertyTaxRefund.value + +MedicalRefund.value
		if (TotalRefund	 == 0) return;
		SummaryA.innerHTML = "";
		SummaryB.innerHTML = "";

		var StateRT = Math.round(StateTaxRefundTaxable);
		if (StateTaxRefund.value) {
			SummaryA.innerHTML += "<br />State Tax portion = " + StateRT;
		}
		var TotalNotStateTaxable = StateRT;

		var SalesRT = Math.round(SalesTaxRefundTaxable);
		if (SalesTaxRefund.value) {
			SummaryB.innerHTML += "<br />Sales Tax portion = " + SalesRT;
		}

		var MedicRT = Math.round(MedicalRefundTaxable);
		if (MedicalRefund.value) {
			SummaryB.innerHTML += "<br />Medical portion = " + MedicRT;
		}
		var TotalStateTaxable = SalesRT + MedicRT;

		var PropyRT = Math.round(PropertyTaxRefundTaxable);
		if (PropertyTaxRefundBox.checked) {
			if (PropertyTaxRefund.value) {
				SummaryB.innerHTML += "<br />Property Tax portion = " + PropyRT;
			}
			TotalStateTaxable += PropyRT;
		}
		else {
			if (PropertyTaxRefund.value) {
				SummaryA.innerHTML += "<br />Property Tax portion = " + PropyRT;
			}
			TotalNotStateTaxable += PropyRT;
		}

		TaxableState.value = TotalNotStateTaxable;
		TaxableSales.value = TotalStateTaxable;

		TotalTaxable = TotalStateTaxable + TotalNotStateTaxable;
		if ((TotalTaxable == 0) || ComputationComplete) {
			TestingNonRefundableFor.innerHTML = "";
			NonRefundableButton.style.display = "none";
			ResultsDiv.style.backgroundColor = "lightgreen";
			NotDone.style.display = "none";
			RefundsButton.style.display = "none";
		}

		if ((StateTaxRefund.value > 0) && (StateTaxRefundTaxable == 0) && (! StateTaxRefundAlert)) {
			Message = "Your state income tax refund is not taxable.";
			StateTaxRefundAlert = true;
		}

		if ((SalesTaxRefund.value > 0) && (SalesTaxRefundTaxable == 0) && (! SalesTaxRefundAlert)) { 
			Message += "\nYour sales tax refund is not taxable.";
			SalesTaxRefundAlert = true;
		}

		if ((PropertyTaxRefund.value > 0) && (PropertyTaxRefundTaxable == 0) && (! PropertyTaxRefundAlert)) {
			Message += "\nYour property tax refund is not taxable.";
			PropertyTaxRefundAlert = true;
		}

		if ((MedicalRefund.value > 0) && (MedicalRefundTaxable == 0) && (! MedicalRefundAlert)) {
			Message += "\nYour medical refund is not taxable.";
			MedicalRefundAlert = true;
		}

		if (TotalTaxable == 0) {
			if (! ComputationCompleteAlert) {
				Message += "\nComputation complete";
				ComputationCompleteAlert = true;
			}
			ComputationComplete = true;
			ResultsDiv.style.backgroundColor = "lightgreen";
			for (j = 0; j < MyinputList.length; j++) {
				if (! MyinputList[j].disabled) MyinputList[j].style.backgroundColor = "";
			}
		}

		switch (result_line) {
			case "SchedAResult": QBIDiv.style.display = "none";
			case "QBIResult": NonTaxableDiv.style.display = "none";
			case "NonTaxableResult": NonRefundableDiv.style.display = "none";
		}

		if (result_line) document.getElementById(result_line).innerHTML = TotalTaxable;
		if (Message) alert(Message);
		return (TotalTaxable == 0);
	}

</script>

</head>

<!-- ******************************************************************************************************** -->
<!-- **************************************** START OF HTML ************************************************* -->
<!-- ******************************************************************************************************** -->

<body onload="Initialize()">

<center>
	<span class="title">Taxable Refund and Recovery Calculator</span>
	<br><span id="Version"></span>
	<script>Version.innerHTML = VERSION;</script>
	<br />&nbsp;

	<div id="ClearAndPrint" class="new_block noPrint">
		<button onclick="window.open(window.location, '_self');">Clear and reset calculator</button>
		<br /><button onclick="window.print()">Print a taxpayer copy</button>
	</div>

	<div class="new_block" id="TPNameDiv" onchange="Recalculate();">
		<center>
		<table id="taxpayer_table">
			<tr><td></td><td></td><td></td><td></td><td></td></tr>
			<tr><td></td><td></td><td colspan="3"><h1 id="TPNameHeader"></h1><td/>
			<tr>	<td><span class="inputTitle">This Tax Year: </span>
					<select style="width:6em;" id="TaxYear" title="Select the tax year being prepared."></select></td>
				<td></td>
				<td class="inputTitle">Taxpayer&apos;s Name: </td>
				<td colspan="2"><input id="TPName" title="Enter the taxpayer's name. Consider printing the results for the taxpayer's record" /></td></tr>
			<tr>	<td></td><td></td>
				<td class="inputTitle">Filing Status:
					<br /><span id="DependentsRow">Dependents:</span></td>
				<td><select id="FilingStatus" title="Select the taxpayer's filing status.">
					<option value="SNG">Single</option>
					<option value="MFJ">MFJ</option>
					<option value="MFS">MFS</option>
					<option value="HOH">HOH</option>
					<option value="WID">Widow(er)</option></select>
				<br /><span id="DependentsNumber"><input id="Dependents" type="myinput" /></span></td>
				<td><input id="TP65" type="checkbox" title="Taxpayer was 65 or older" /> TP was 65 or older,
				<input id="TPBlind" type="checkbox" title="Taxpayer was blind" /> TP was blind
				<br /><input id="SP65" type="checkbox" title="Spouse was 65 or older" /> SP was 65 or older,
				<input id="SPBlind" type="checkbox" title="Spouse was blind" /> SP was blind
				</td></tr>
				<tr>	<td></td><td colspan="3"></td>
				<td id="SNGDependent"><input id="Dependent" type="checkbox"> Dependent on another taxpayer&apos;s return</td></tr>
			<tr>	<td></td><td colspan="3"></td>
				<td id="MFSItemize"><input id="MustItemize" type="checkbox"> Must itemize because spouse itemized</td></tr>
		</table>
	</center>
	</div>
</center>
	
<div id="InstructionDiv" class="new_block">
	<span onclick="Do_Instructions();"><h1 id="instruction_label">Click to show instructions</h1></span>
	<div id="instructions">
		Data entry notes:
		<ul>
			<li>Values in the fields are not recognized until you tab or click out of the field.</li>
			<li>Boxes highlighted in yellow require an entry before the calculation is done.</li>
			<li>A blank field does not necessarily mean zero. Enter 0 if appropriate when an entry is required.</li>
		</ul>

		If the sales tax amount is not shown on the previous year return printout,
		use the <a href="https://apps.irs.gov/app/stdc/" target="_blank">IRS sales tax calculator</a> to determine the amount.

		<br /><br />Taxability on refund amounts are determined by entries on the previous year return which include:
		<ul>
			<li>The difference between Sales Tax and State Withholding used in Schedule A.</li>
			<li>The effect of the state and local tax (&quot;SALT&quot;) deduction limitation in tax years 2018 and later.</li>
			<li>The total itemized deductions which exceeded the standard deduction.</li>
			<li>The extent to which itemized deductions were limited (Not considered due to high income required)</li>
			<li>The amount of a cash contribution deduction available due to potential reduced itemized deductions (TaxSlayer does not consider this).</li>
			<li>The amount of additional QBI deduction available due to potential reduced itemized deductions (TaxSlayer does not consider this).</li>
			<li>The amount of a taxable amount that was negative (TaxSlayer does not consider this).</li>
			<li>Nonrefundable tax credits that were available but not fully used to reduce tax (TaxSlayer does not consider this).</li>
			<li>The amount of the refund or the pro-rated amount of the refund if estimated taxes were paid after December 31st.</li>
			<li>Apportionment of refund to taxable or non-taxable to the state based on refund types</li>
			<li>Refunds for any but the one preceding year are not considered because they are out of scope.</li>
		</ul>
		Resulting taxable amounts are shown for the current year.
		<br />Note: Effect of using taxability of Schedule D (unlikely condition) is not considered in nonrefundable credit section.
	</div>
</div>

<div id="DataEntryDiv" class="new_block" onchange="Recalculate();">
	<div id="Refunds">
		<h1 id="RefundHeader"></h1>
		<table class="data_entry">
			<tr>	<td>State income tax refund amount:</td>
				<td><input id="StateTaxRefund" type="myinput" /></td>
				<td>Refund due to overpayment of state income tax that was used as a deduction on Schedule A
					<span id="EstQ4Questions">
						<br /><input id="Est4QYes" type="checkbox" /> <span id="Est4Q"></span>
					</span>
					</td></tr>
			<tr>	<td>Sales tax refund amount:</td>
				<td><input id="SalesTaxRefund" type="myinput" /></td>
				<td>Refund due to a refund of sales tax paid on an item that was used to augment the state sales tax deduction on Schedule A
					(return of a car or boat, for example - very rare event)
					</td></tr>
			<tr>	<td>Real estate tax refund amount:</td>
				<td><input id="PropertyTaxRefund" type="myinput" /></td>
				<td>Refund or rebate of state real estate taxes used as a deduction on Schedule A
				<br /><input id="PropertyTaxRefundBox" type="checkbox" checked="checked">
				Check if this refund IS taxable to the state or will be deducted on the state return.</td></tr>
			<tr>	<td>Medical refund amount:
				<td><input id="MedicalRefund" type="myinput" /></td>
				<td>Repayment of expenses by insurance or other reimbursement for medical expenses used as a deduction on Schedule A</td></tr>
<!--
			<tr>	<td>Other recoverable amounts:
				<td><input id="OtherRefund" type="myinput" /></td>
				<td>Refund or recovery of other expenses that provided an adjustment or reduction of taxes</td></tr>
-->
		</table>
		<button id="RefundsButton">Next</button>
	</div> <!-- Refunds -->
</div> <!-- DataEntry -->

<div id="TaxCalcDiv" class="new_block" onchange="Tax_Calc();">
	<div id="SchedADiv">
		<h1 id="SchedAHeader"></h1>
		<h2 id="TestingSchedAFor"></h2>
		<table class="data_entry">
			<tr><td> </td><td> </td><td> </td></tr>
			<tr id="MedicalRow" class="hidden">
				<td>4. Medical deduction:</td>
				<td><input id="Medical" type="myinput" /></td>
				<td>Enter the medical deduction that was allowed on Schedule A</td></tr>
			<tr id="StateWHRow" class="hidden">
				<td>
					<table>
					<tr>
						<td id="StateWHLabel" style="min-width: auto; width: 1.5em; max-width: 1.5em;">5a.<br />5b.</td>
						<td style="min-width: auto; width: auto;">State&nbsp;&amp;&nbsp;Local&nbsp;Income&nbsp;taxes:
							<br />General&nbsp;Sales&nbsp;taxes:</td></tr>
					</table></td>
				<td>	<input id="StateWH" type="myinput" />
						<br /><input id="SalesTax" type="myinput" /></td>
				<td>	<input id="StateWHBox" type="checkbox" onchange="ChangeTaxBox(this.id)" />
					<input id="SalesTaxUsedBox" type="checkbox" onchange="ChangeTaxBox(this.id)" />
					Check if box 5a was checked <span id="StateWHText"></span>
					<br /><span id="SalesTaxText"><!-- pre 2018 -->
					<input id="SalesTaxBox" type="checkbox" onchange="ChangeTaxBox(this.id)" />
					Check if box 5b was checked</span>
					<a id="IRSbutton" href="https://apps.irs.gov/app/stdc/" target="_blank">
						<button> IRS Calc </button></a>
					<input id="NoSalesTaxBox" type="checkbox" onchange="ChangeTaxBox(this.id)" /> Check if your state has no sales tax</td></tr>
			<tr id="PropertyRow" class="xhidden">
				<td><span id="PropertyLineNo">TBD</span>. State/local real estate taxes:</td>
				<td><input id="Property" type="myinput" /></td>
				<td></td></tr>
			<tr id="PersonalRow" class="xhidden">
				<td>5c. Personal property taxes:</td>
				<td><input id="Personal" type="myinput" /></td>
				<td></td></tr>
			<tr id="SALTRow" class="hidden">
				<td><span id="SALTLineNo">TBD</span>. State &amp; Local tax total:</td>
				<td><input id="SALT" type="myinput" disabled="true"/></td>
				<td>&quot;SALT&quot; total prior to <span id="SALTLimit"></span> limit</td></tr>
			<tr id="CashContribRow"><td><span id="CashContribLineNo">TBD</span>. Cash contributions:</td>
				<td><input id="CashContrib" type="myinput" /></td>
				<td></td></tr>
			<tr id="ItemizedRow"><td><span id="ItemizedLineNo">TBD</span>. Total itemized deductions:</td>
				<td><input id="Itemized" type="myinput" /></td>
				<td><input id="UseSchedA" type="checkbox" />
					Check if the line <span id="UseSchedALineNo">TBD</span> box was checked.
					(Standard deduction = <span id="CYStandard"></span>)</td></tr>
			<tr id="RevisedItemizedRow"><td>Revised deductions:</td>
				<td><input id="RevisedItemized" type="myinput" disabled="true" /></td>
				<td>(Calculated)</td></tr>
			<tr>	<td></td><td></td>
				<td class="test_results">Taxable amount of the refund after this test: 
					<span id="SchedAResult">TBD</span></td></tr>
		</table>
		<button id="SchedAButton" class="hidden">Next</button>
	</div> <!-- SchedADiv -->

	<div id="StandardDiv" class="hidden">
		<h1 id="StandardHeader"></h1>
		<h2 id="TestingStandardFor"></h2>
		<table class="data_entry">
			<tr><td>Salary and wages:</td>
				<td><input id="Salary" type="myinput" /></td>
				<td id="SalaryText"></td></tr>
			<tr><td>Business income:</td>
				<td><input id="Business" type="myinput" /></td>
				<td id="BusinessText"></td></tr>
			<tr><td>Standard deduction:</td>
				<td><input id="StandardDeduction" type="myinput" disabled="true" /></td>
				<td>(Calculated)</td></tr>
		</table>
		<button id="StandardButton" class="hidden">Next</button>
	</div> <!-- StandardDiv -->

	<div id="QBIDiv" class="hidden">
		<h1 id="QBIHeader"></h1>
		<h2 id="TestingQBIFor"></h2>
		<input id="QBITestSkip" type="checkbox" />
			Check this box to skip this test if there is no qualified business income
			or Section 199A income on dividends or K1s
		<table id="QBITable1" class="data_entry">
			<tr id="QBIAGIRow"><td>Adjusted gross income:</td>
				<td><input id="QBIAGI" type="myinput" /></td>
				<td>From <span id="QBIAGILineNo">TBD</span></td></tr>
			<tr><td colspan="3"><input id="QBINoWorksheet" type="checkbox" />
				Check this box if you don&apos;t have access to the QBI worksheet (Form 8995)</td></tr>
		</table>
		<table id="QBITable2" class="data_entry">
			<tr id="QBIBusinessRow"><td>Business income:</td>
				<td><input id="QBIBusiness" type="myinput" /></td>
				<td>From <span id="QBIBusinessLineNo">TBD</span></td></tr>
			<tr id="QBISETaxRow"><td>SE Tax Adjustment:</td>
				<td><input id="QBISETax" type="myinput" disabled="true" /></td>
				<td>(Calculated)</td></tr>
			<tr id="QBISEPRow"><td>SE SEP/SIMPLE Adjustment:</td>
				<td><input id="QBISEP" type="myinput" /></td>
				<td>From <span id="QBISEPLineNo">TBD</span></td></tr>
			<tr id="QBISEHIRow"><td>SE Health Ins Adjustment:</td>
				<td><input id="QBISEHI" type="myinput" /></td>
				<td>From <span id="QBISEHILineNo">TBD</span></td></tr>
			<tr id="QBICGRow"><td>Positive Capital Gains income:</td>
				<td><input id="QBICG" type="myinput" /></td>
				<td>From <span id="QBICGLineNo">TBD</span></td></tr>
			<tr id="QBIDividendRow"><td>Qualified Dividend income:</td>
				<td><input id="QBIDividend" type="myinput" /></td>
				<td>From <span id="QBIDividendLineNo">TBD</span></td></tr>
			<tr id="QBI199ARow"><td>Dividend/K1 199A income:</td>
				<td><input id="QBI199A" type="myinput" /></td>
				<td>From K1 and dividend statements</td></tr>
		</table>
		<table id="QBITable3" class="data_entry">
			<tr id="QBIDMaximumRow"><td>Maximum QBI deduction:</td>
				<td><input id="QBIDMaximum" type="myinput" /></td>
				<td id="QBIDMaximumLineNo">TBD</td></tr>
			<tr id="QBINetCGRow"><td>Net capital gains:</td>
				<td><input id="QBINetCG" type="myinput" /></td>
				<td id="QBINetCGLineNo">TBD</td></tr>
			<tr id="QBIDCurrentRow"><td>Current QBI deduction:</td>
				<td><input id="QBIDCurrent" type="myinput" disabled="true" /></td>
				<td id="QBIDCurrentLineNo">TBD</td></tr>
			<tr id="QBIDAdditionalRow"><td>Additional QBI deduction:</td>
				<td><input id="QBIDAdditional" type="myinput" disabled="true" /></td>
				<td id="QBIDAdditionalText"></td></tr>
			<tr>	<td></td><td></td>
				<td class="test_results">Taxable amount of the refund after this test: 
					<span id="QBIResult">TBD</span></td></tr>
		</table>
	</div> <!-- QBIDiv -->

	<div id="NonTaxableDiv" class="hidden">
		<h1 id="NonTaxableHeader"></h1>
		<h2 id="TestingNonTaxableFor"></h2>
		<span id="NonTaxableOption">
			<input id="NonTaxableSkip" type="checkbox" />
			Check this box to skip this test if the taxable income (<span id="NonTaxableSkipLineNo">TBD</span>) is greater than zero
		</span>
		<table id="NonTaxableTable" class="data_entry">
			<tr id="AGIRow"><td>Adjusted gross income:</td>
				<td><input id="AGI" type="myinput" /></td>
				<td>From <span id="AGILineNo">TBD</span></td></tr>
			<tr id="ExemptionRow"><td>Exemption amount:</td>
				<td><input id="Exemption" type="myinput" disabled="true" /></td>
				<td><span id="ExemptionText"></span></td></tr>
			<tr id="NonTaxableRecoveredRow"><td>Negative income recovered:</td>
				<td><input id="NonTaxableRecovered" type="myinput" disabled="true" /></td>
				<td>(Calculated)</tr>
			<tr id="NonTaxableQBIDRow"><td>Additional QBI deduction:</td>
				<td><input id="NonTaxableQBID" type="myinput" disabled="true" /></td>
				<td>(Calculated from business and 199A dividend income)</tr>
			<tr>	<td></td><td></td>
				<td class="test_results">Taxable amount of the refund after this test: 
					<span id="NonTaxableResult">TBD</span></td></tr>
		</table>
		<button id="NonTaxableButton" class="hidden">Next</button>
		<span id="TaxablePositive">Taxable income is positive. Please check the box above to skip this test.</span>
	</div> <!-- NonTaxableDiv -->

	<div id="NonRefundableDiv" class="hidden">
		<h1 id="NonRefundableHeader"></h1>
		<h2 id="TestingNonRefundableFor"></h2>
		<br /><input id="NoNonRefundables" type="checkbox" />
		Check this box to skip this test if either:
		<ul>
			<li>all credits were used &mdash; the tax amount <u>after</u> non-refundable credits
			(<span id="PostCreditLineNo">1040 line 13</span>) is not zero, or</li>
			<li>you know that the taxpayer has no eligible non-refundable credits</li>
		</ul>
		<table id="NonRefundableTable" class="data_entry">
			<tr class="underline"><td colspan="3">Original amounts:</td></tr>
			<tr>	<td>&nbsp;&nbsp;Total non-refundable credits:</td>
				<td><input id="OldCredits" type="myinput" /></td>
				<td>From 1040 line <span id="OldNRCreditsLineNo">TBD</span></td></tr>
		</table>
		<table id="NonRefundableAmendedTable" class="data_entry">
			<tr>	<td colspan="3"><span class="comment">
					<br />Enter the maximum amount of non-refundable credits from
					the forms on which they are calculated.
					<br />HINT 1: If there is a credit shown, all credits prior to
					that one <u>are</u> the maximum - no need to hunt for them.
					<br />HINT 2: Start with CTC and Ed credits first -
					they usually have the most effect.</span></td></tr>
			<tr class="underline"><td colspan="3">Maximum amounts:</td></tr>
			<tr>	<td>&nbsp;&nbsp;Foreign tax credit:</td>
				<td><input id="ForeignTax" type="myinput" /></td>
				<td>Form 1116</td></tr>
			<tr>	<td>&nbsp;&nbsp;Credit for care expenses:</td>
				<td><input id="ChildCare" type="myinput" /></td>
				<td>From Form 2441 line 9</td></tr>
			<tr>	<td>&nbsp;&nbsp;Credit for the elderly:</td>
				<td><input id="Elderly" type="myinput" /></td>
				<td>From Schedule R line 20</td></tr>
			<tr>	<td>&nbsp;&nbsp;Education credits:</td>
				<td><input id="Education" type="myinput" /></td>
				<td>From Form 8863 lines 9 + 18</td></tr>
			<tr>	<td>&nbsp;&nbsp;Retirement savings credit:</td>
				<td><input id="Retirement" type="myinput" /></td>
				<td>From Form 8880 line 10</td></tr>
			<tr><td colspan="3"></td></tr>
			<tr id="EnergyRow"> <!-- not available after 2017 -->
				<td>&nbsp;&nbsp;Residential energy credit:</td>
				<td><input id="Energy" type="myinput" /></td>
				<td>From Form 5695 line 13</td></tr>
			<tr id="CTCRow">
				<td>&nbsp;&nbsp;Child/dependent tax credit:</td>
				<td><input id="CTC" type="myinput" disabled="true" /></td>
				<td>	<span id="CTCTable">
						AGI:&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
						<input id="CTCAGI" type="myinput" />
						From <span id="CTCAGIText"></span>
						<br />Dep &lt; 17:
						<input id="CTCCount" type="myinput" />
						Number of dependents aged 16 or less, or disabled
						<span id="CTC0CountRow">
							(including < age 6)
							<br />Dep &lt; 6:&nbsp;&nbsp;
							<input id="CTC0Count" type="myinput" />
							Number of dependents under 6, or disabled
						</span>
						<span id="ODCCountRow">
							<br />Dep &gt; 16:
							<input id="ODCCount" type="myinput" />
							Number of other dependents
						</span>
					</span></tr>
			<tr>	<td style="border-top:2px solid black;">
					New total non-refundable credits:</td>
				<td style="border-top:2px solid black;">
					<input id="NewCredits" type="myinput" disabled="true" /></td>
				<td>(Calculated)</td></tr>
			<tr>	<td>Non-refundable amount gained:</td>
				<td><input id="NRCGain" type="myinput" disabled="true" /></td>
				<td>(Calculated)</td></tr>
			<tr>	<td>Pre-tax amount gained:</td>
				<td><input id="TaxBracketGain" type="myinput" disabled="true" /></td>
				<td id="TaxBracket"></td></tr>
			<tr>	<td></td><td></td>
				<td class="test_results">Taxable amount of the refund after this test: 
					<span id="NonRefundableResult">TBD</span></td></tr>
		</table>
		<button id="NonRefundableButton" class="hidden">Next</button>
	</div> <!-- NonRefundableDiv -->

	<div id="AllocationDiv" class="hidden">
		<h1 id="AllocationHeader"></h1>
		<h2 id="TestingAllocationFor"></h2>
		<span class="instruction">State tax payments for a tax year may include payments
			for a previous year and payments may also be paid in the following year,
			both typically the fourth quarter estimated tax payments or,
			a payment with an automatic extension to file.
			This section allocates the state tax refund to just the payments
			for the tax year to which the refund applies.
			<br /><b>Only enter amounts if claimed as a deduction.</b></span>
			<br /><input id="NoAllocation" type="checkbox" />
			Check if you do not have the data (the taxable state tax refund will not be additionally reduced by allocation)
		<table id="AllocationTable" class="data_entry">
			<tr class="underline">
				<td colspan="3"><br \><span id="PYEstimatesQ"></span></td></tr>
			<tr id="EstPY4QRow"><td id="EstPY4QLabel"></td>
				<td><input id="EstPY4Q" type="myinput" /></td>
				<td id="EstPY4QText"></td></tr>
			<tr id="DuePY4QRow"><td id="DuePY4QLabel"></td>
				<td><input id="DuePY4Q" type="myinput" /></td>
				<td></td></tr>
			<tr class="underline">
				<td colspan="3"><br /><span id="CYEstimatesQ"></span></td></tr>
			<tr id="PaidCYRow"><td id="PaidCYLabel"></td>
				<td><input id="PaidCY" type="myinput" disabled="true"/></td>
				<td id="PaidCYText">(Calculated) May include Q4 estimated payment if paid prior to 12/31.</td></tr>
			<tr class="underline">
				<td colspan="3"><br /><span id="NYEstimatesQ"></span></td></tr>
			<tr id="EstNY4QRow"><td id="EstNY4QLabel"></td>
				<td><input id="EstNY4Q" type="myinput" /></td>
				<td id="EstNY4QText">Note: this may not be fully deductible. See results below.</td></tr>
			<tr class="underline">
				<td colspan="3"><br />State income tax refund allocation:</td></tr>
			<tr>	<td id="CYAllocLabel"></td>
				<td><input id="CYAlloc" type="myinput" disabled="true" /></td>
				<td></td></tr>
			<tr>	<td id="NYAllocLabel"></td>
				<td><input id="NYAlloc" type="myinput" disabled="true" /></td>
				<td id="NYAllocText"></td>
			</tr>
		</table>
		<button id="AllocationButton" class="hidden">Next</button>
	</div> <!-- AllocationDiv -->
</div>

<div id="ResultsDiv" class="new_block">
	<h1>Results for TaxSlayer Entry</h1>
	<h2 id="NotDone">Result is not yet final - complete all yellow boxes</h2>
	<table class="data_entry">
		<tr id="TaxableStateHeader">
			<td colspan="3" class="underline">Federal taxable amount of refunds NOT taxable to the state:</td></tr>
		<tr id="TaxableStateRow">
			<td><span id="TaxableStateLabel">1040 line 10</span></td>
			<td><input id="TaxableState" type="myinput" disabled="true"/></td>
			<td class="comment">(TS Income &gt; Form 1099-G Box 2 &gt;
				Bypass worksheet line)<span id="SummaryA"></span><br /> </td></tr>
		<tr id="TaxableSalesHeader">
			<td colspan="3" class="underline">Federal taxable amount of refunds taxable to the state:</td></tr>
		<tr id="TaxableSalesRow">
			<td><span id="TaxableSalesLabel">1040 line 21</span></td>
			<td><input id="TaxableSales" type="myinput" disabled="true" /></td>
			<td class="comment">(TS Income &gt; Other Income)<span id="SummaryB"></span></td></tr>
		<tr id="DedNY4QHeader">
			<td colspan="3" class="underline"><br /><span id="DedNY4QYear"></span> 4th quarter estimated payment:</td></tr>
		<tr id="DedNY4QRow">
			<td><span class="comment">Part of Sched A line 5a</span></td>
			<td><input id="DedNY4Q" type="myinput" disabled="true" /></td>
			<td>(Federal Section &gt; Deductions &amp; Itemized Deductions &gt;
				Taxes You Paid &gt; Prior Year 4th Quarter...)<span id="SummaryC"></span></td></tr>
	</table>

</div> <!-- CurrentYear -->

<div class="noPrint new_block">
	  Please send corrections and suggestions to
	  <a href="mailto:jeff@bogarthome.net">jeff@bogarthome.net</a>
	  <span id="printbutton2" style="float: right;">
		  <button onclick="window.print()">Print a taxpayer copy</button>
	  </span>
</div>
